#!/bin/bash
# ============================================================================
# venv 가상환경 자동 설정 스크립트 (Linux/Mac)
# ============================================================================
#
# 사용법:
#   chmod +x setup_venv.sh
#   ./setup_venv.sh
#
# 이 스크립트는 다음 작업을 수행합니다:
# 1. venv 가상환경 생성
# 2. 가상환경 활성화
# 3. pip 업그레이드
# 4. requirements.txt의 패키지 설치
# ============================================================================

set -e  # 오류 발생 시 스크립트 중단

echo "======================================================================"
echo "Food-101 프로젝트 가상환경 설정 시작 (venv)"
echo "======================================================================"

# ----------------------------------------------------------------------------
# 1단계: Python 버전 확인
# ----------------------------------------------------------------------------
echo ""
echo "1. Python 버전 확인 중..."
python_version=$(python --version 2>&1)
echo "   $python_version"

# Python 3.8 이상 확인
python_major=$(python -c 'import sys; print(sys.version_info.major)')
python_minor=$(python -c 'import sys; print(sys.version_info.minor)')

if [ "$python_major" -lt 3 ] || ([ "$python_major" -eq 3 ] && [ "$python_minor" -lt 8 ]); then
    echo "   ⚠️  Python 3.8 이상이 필요합니다."
    exit 1
fi

echo "   ✓ Python 버전 확인 완료"

# ----------------------------------------------------------------------------
# 2단계: 기존 가상환경 확인
# ----------------------------------------------------------------------------
echo ""
echo "2. 기존 가상환경 확인 중..."

if [ -d "venv" ]; then
    echo "   ⚠️  기존 venv 폴더가 발견되었습니다."
    read -p "   삭제하고 새로 생성하시겠습니까? (y/N): " confirm

    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        echo "   기존 가상환경 삭제 중..."
        rm -rf venv
        echo "   ✓ 삭제 완료"
    else
        echo "   설치를 중단합니다."
        exit 0
    fi
fi

# ----------------------------------------------------------------------------
# 3단계: 가상환경 생성
# ----------------------------------------------------------------------------
echo ""
echo "3. 가상환경 생성 중..."
python -m venv venv
echo "   ✓ venv 가상환경이 생성되었습니다."

# ----------------------------------------------------------------------------
# 4단계: 가상환경 활성화 및 pip 업그레이드
# ----------------------------------------------------------------------------
echo ""
echo "4. 가상환경 활성화 및 pip 업그레이드 중..."
source venv/bin/activate

# pip 업그레이드
pip install --upgrade pip setuptools wheel --quiet
echo "   ✓ pip 업그레이드 완료"

# ----------------------------------------------------------------------------
# 5단계: requirements.txt 설치
# ----------------------------------------------------------------------------
echo ""
echo "5. 필요한 패키지 설치 중..."
echo "   (이 과정은 몇 분 정도 걸릴 수 있습니다...)"

if [ -f "requirements.txt" ]; then
    pip install -r requirements.txt
    echo "   ✓ 모든 패키지 설치 완료"
else
    echo "   ⚠️  requirements.txt 파일을 찾을 수 없습니다."
    exit 1
fi

# ----------------------------------------------------------------------------
# 6단계: 설치 확인
# ----------------------------------------------------------------------------
echo ""
echo "6. 설치 확인 중..."
python -c "import torch; import torchvision; print(f'   ✓ PyTorch {torch.__version__} 설치됨')"
python -c "import numpy; import pandas; print('   ✓ NumPy, Pandas 설치됨')"
python -c "import matplotlib; import seaborn; print('   ✓ Matplotlib, Seaborn 설치됨')"

# ----------------------------------------------------------------------------
# 완료 메시지
# ----------------------------------------------------------------------------
echo ""
echo "======================================================================"
echo "✓ 가상환경 설정이 완료되었습니다!"
echo "======================================================================"
echo ""
echo "다음 명령어로 가상환경을 활성화하세요:"
echo "  source venv/bin/activate"
echo ""
echo "가상환경을 비활성화하려면:"
echo "  deactivate"
echo ""
echo "이제 다음 단계를 진행하세요:"
echo "  python download_dataset.py"
echo "======================================================================"
