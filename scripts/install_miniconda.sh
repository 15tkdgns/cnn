#!/bin/bash
# ============================================================================
# Miniconda 설치 스크립트 (Linux)
# ============================================================================
#
# 사용법:
#   chmod +x install_miniconda.sh
#   ./install_miniconda.sh
#
# 이 스크립트는 다음 작업을 수행합니다:
# 1. Miniconda 다운로드
# 2. Miniconda 설치
# 3. conda 초기화
# ============================================================================

set -e  # 오류 발생 시 스크립트 중단

echo "======================================================================"
echo "Miniconda 설치 시작"
echo "======================================================================"

# ----------------------------------------------------------------------------
# 1단계: 시스템 아키텍처 확인
# ----------------------------------------------------------------------------
echo ""
echo "1. 시스템 정보 확인 중..."
ARCH=$(uname -m)
echo "   아키텍처: $ARCH"

# 다운로드 URL 설정
if [ "$ARCH" = "x86_64" ]; then
    MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh"
elif [ "$ARCH" = "aarch64" ]; then
    MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh"
else
    echo "   ❌ 지원하지 않는 아키텍처입니다: $ARCH"
    exit 1
fi

# ----------------------------------------------------------------------------
# 2단계: 기존 conda 설치 확인
# ----------------------------------------------------------------------------
echo ""
echo "2. 기존 conda 설치 확인 중..."

if command -v conda &> /dev/null; then
    echo "   ⚠️  conda가 이미 설치되어 있습니다."
    conda --version
    read -p "   계속 진행하시겠습니까? (y/N): " confirm
    if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
        echo "   설치를 중단합니다."
        exit 0
    fi
fi

# ----------------------------------------------------------------------------
# 3단계: Miniconda 다운로드
# ----------------------------------------------------------------------------
echo ""
echo "3. Miniconda 다운로드 중..."
echo "   URL: $MINICONDA_URL"

INSTALL_DIR="$HOME/miniconda3"
TEMP_FILE="/tmp/miniconda.sh"

# 기존 파일 삭제
rm -f "$TEMP_FILE"

# 다운로드
if command -v wget &> /dev/null; then
    wget -q --show-progress "$MINICONDA_URL" -O "$TEMP_FILE"
elif command -v curl &> /dev/null; then
    curl -L "$MINICONDA_URL" -o "$TEMP_FILE"
else
    echo "   ❌ wget 또는 curl이 필요합니다."
    exit 1
fi

echo "   ✓ 다운로드 완료"

# ----------------------------------------------------------------------------
# 4단계: Miniconda 설치
# ----------------------------------------------------------------------------
echo ""
echo "4. Miniconda 설치 중..."
echo "   설치 경로: $INSTALL_DIR"

# 배치 모드로 설치 (자동 yes)
bash "$TEMP_FILE" -b -p "$INSTALL_DIR"

echo "   ✓ 설치 완료"

# 임시 파일 삭제
rm -f "$TEMP_FILE"

# ----------------------------------------------------------------------------
# 5단계: conda 초기화
# ----------------------------------------------------------------------------
echo ""
echo "5. conda 초기화 중..."

# conda 초기화
"$INSTALL_DIR/bin/conda" init bash

echo "   ✓ conda 초기화 완료"

# ----------------------------------------------------------------------------
# 6단계: 환경 변수 설정
# ----------------------------------------------------------------------------
echo ""
echo "6. 환경 변수 설정 중..."

# 현재 세션에서 conda 활성화
source "$INSTALL_DIR/etc/profile.d/conda.sh"

# conda 버전 확인
conda --version

echo "   ✓ conda가 정상적으로 설치되었습니다."

# ----------------------------------------------------------------------------
# 완료 메시지
# ----------------------------------------------------------------------------
echo ""
echo "======================================================================"
echo "✓ Miniconda 설치가 완료되었습니다!"
echo "======================================================================"
echo ""
echo "⚠️  중요: 터미널을 재시작하거나 다음 명령어를 실행하세요:"
echo "  source ~/.bashrc"
echo ""
echo "그 다음 Food-101 환경을 생성하세요:"
echo "  ./setup_conda.sh"
echo ""
echo "======================================================================"
