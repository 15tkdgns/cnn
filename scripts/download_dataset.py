"""
Food-101 데이터셋 다운로드 스크립트

이 스크립트는 Kaggle에서 Food-101 데이터셋을 자동으로 다운로드하고,
데이터셋의 구조를 확인한 후 경로를 파일로 저장합니다.

작성일: 2025
목적: Food-101 이미지 분류 프로젝트의 데이터 준비 단계
"""

# ============================================================================
# 라이브러리 임포트
# ============================================================================
import os  # 운영체제와 상호작용하기 위한 모듈 (파일/디렉토리 작업)
import kagglehub  # Kaggle 데이터셋을 쉽게 다운로드하기 위한 라이브러리
from pathlib import Path  # 경로를 객체지향적으로 다루기 위한 모듈 (os.path보다 편리함)


def download_food101_dataset():
    """
    Food-101 데이터셋을 Kaggle에서 다운로드하고 경로를 반환하는 함수

    동작 과정:
    1. kagglehub를 사용하여 "dansbecker/food-101" 데이터셋 다운로드
    2. 다운로드된 데이터셋의 디렉토리 구조 탐색 및 출력
    3. 데이터셋 경로를 텍스트 파일로 저장 (다른 스크립트에서 재사용)

    Returns:
        str: 다운로드된 데이터셋의 전체 경로

    주의사항:
        - 인터넷 연결이 필요합니다 (약 10GB 다운로드)
        - Kaggle API 인증이 설정되어 있어야 합니다
        - 첫 다운로드 시 시간이 오래 걸릴 수 있습니다
    """
    # ------------------------------------------------------------------------
    # 1단계: 다운로드 시작 메시지 출력
    # ------------------------------------------------------------------------
    print("=" * 60)
    print("Food-101 데이터셋 다운로드 시작...")
    print("=" * 60)

    # ------------------------------------------------------------------------
    # 2단계: Kaggle에서 데이터셋 다운로드
    # ------------------------------------------------------------------------
    # kagglehub.dataset_download()는 자동으로:
    # - 데이터셋을 캐시 디렉토리에 다운로드 (~/.cache/kagglehub/)
    # - 이미 다운로드되어 있으면 재다운로드하지 않음 (캐시 활용)
    # - 다운로드된 경로(문자열)를 반환
    path = kagglehub.dataset_download("dansbecker/food-101")

    # 다운로드 완료 메시지 및 경로 출력
    print(f"\n✓ 다운로드 완료!")
    print(f"데이터셋 경로: {path}")

    # ------------------------------------------------------------------------
    # 3단계: 데이터셋 구조 확인 및 출력
    # ------------------------------------------------------------------------
    print("\n" + "=" * 60)
    print("데이터셋 구조:")
    print("=" * 60)

    # Path 객체로 변환 (문자열보다 경로 조작이 편리함)
    dataset_path = Path(path)

    # 데이터셋 디렉토리가 실제로 존재하는지 확인
    if dataset_path.exists():
        # iterdir()로 디렉토리 내의 모든 항목(파일 및 폴더)을 가져옴
        items = list(dataset_path.iterdir())

        # 알파벳 순으로 정렬하여 각 항목 처리
        for item in sorted(items):
            # ------------------------
            # 3-1. 디렉토리인 경우
            # ------------------------
            if item.is_dir():
                # 하위 항목(파일/폴더)의 개수를 세기
                sub_items = list(item.iterdir())
                print(f"📁 {item.name}/ ({len(sub_items)} items)")

                # 특별 처리: images 폴더인 경우
                # images 폴더는 101개의 클래스 폴더를 포함하므로 처음 5개만 미리보기
                if item.name == "images" and sub_items:
                    # 처음 5개 클래스 폴더 이름을 콤마로 구분하여 표시
                    class_names = ', '.join([s.name for s in sorted(sub_items)[:5]])
                    print(f"   └─ 클래스 폴더 예시: {class_names}...")

                # 특별 처리: meta 폴더인 경우
                # meta 폴더는 classes.txt, train.txt, test.txt 등을 포함
                elif item.name == "meta" and sub_items:
                    # 각 메타 파일을 트리 구조로 표시
                    for meta_file in sorted(sub_items):
                        print(f"   ├─ {meta_file.name}")

            # ------------------------
            # 3-2. 일반 파일인 경우
            # ------------------------
            else:
                # 파일 크기를 바이트 단위로 가져오기
                file_size = item.stat().st_size
                # 천 단위 구분 쉼표를 넣어 가독성 향상
                print(f"📄 {item.name} ({file_size:,} bytes)")

    print("\n" + "=" * 60)

    # ------------------------------------------------------------------------
    # 4단계: 데이터셋 경로를 텍스트 파일로 저장
    # ------------------------------------------------------------------------
    # 왜 경로를 저장하나요?
    # - 다른 스크립트(explore_dataset.py, food101_eda.ipynb)에서
    #   데이터셋 경로를 다시 찾을 필요 없이 이 파일을 읽어서 사용하기 위함
    # - 하드코딩 방지: 절대 경로를 코드에 직접 쓰지 않고 파일로 관리
    with open("dataset_path.txt", "w") as f:
        f.write(path)  # 경로 문자열을 파일에 저장

    print(f"✓ 데이터셋 경로가 'dataset_path.txt'에 저장되었습니다.")

    # 함수의 반환값: 다운로드된 데이터셋의 경로
    return path


# ============================================================================
# 메인 실행 블록
# ============================================================================
# 이 스크립트가 직접 실행될 때만 아래 코드가 실행됨
# (다른 파일에서 import할 때는 실행되지 않음)
if __name__ == "__main__":
    # 데이터셋 다운로드 함수 호출
    dataset_path = download_food101_dataset()

    # ------------------------------------------------------------------------
    # 사용자 안내: 다음 단계 출력
    # ------------------------------------------------------------------------
    print("\n" + "=" * 60)
    print("다음 단계:")
    print("=" * 60)
    print("1. EDA 노트북을 실행하여 데이터 탐색을 시작하세요")
    print("   jupyter notebook food101_eda.ipynb")
    print("\n2. 또는 Python 스크립트로 데이터셋 정보 확인:")
    print("   python explore_dataset.py")
    print("=" * 60)
